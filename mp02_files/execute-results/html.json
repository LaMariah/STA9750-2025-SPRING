{
  "hash": "e614c6f0ba79bb94583f1c0b6f4b1593",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Mini-Project #02: Identifying Environmentally Responsible US Public Transit Systems\"\nauthor: \"La Maria\"\nformat: \n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: show\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n\n\n\n\n# Executive Summary: GTA IV Transit Awards Press Release\n\n::: {.callout-note appearance=\"simple\"}\n## Green Transit Alliance for Investigation of Variance (GTA IV) Announces 2023 Awards for Sustainable Transit Leadership\n:::\n\n**FOR IMMEDIATE RELEASE**  \n**March 25, 2025**\n\nThe Green Transit Alliance for Investigation of Variance (GTA IV) is proud to announce the recipients of its 2023 Green Transit Awards, celebrating transit agencies that are leading the nation in environmental responsibility and sustainable operations.\n\n\"Public transit represents one of our most powerful tools in the fight against climate change,\" said the Executive Director of GTA IV. \"This year's award winners demonstrate that with thoughtful planning and innovative approaches, transit agencies can dramatically reduce their carbon footprint while providing essential mobility services to their communities.\"\n\n### üèÜ The Greenest Transit Agency Award\n\nThe coveted Greenest Transit Agency Award for 2023 goes to **San Francisco Municipal Transportation Agency (SFMTA)** for their light rail operations. SFMTA achieved an impressive **0.14 pounds of CO2 per passenger mile**, which is 83% lower than the national average for transit systems. The agency's strategic investment in clean electricity and high ridership density has resulted in one of the nation's most climate-friendly transit systems.\n\n### üåç Most Emissions Avoided Award\n\n**New York MTA Subway** system has earned our Most Emissions Avoided Award by preventing an estimated **2.3 million metric tons of CO2 emissions** in 2023. This remarkable achievement is equivalent to removing approximately 493,000 passenger vehicles from our roads for an entire year. The agency's extensive network and high ridership demonstrates how effective urban transit planning can yield substantial environmental benefits.\n\n### ‚ö° Innovation in Electrification Award\n\n**King County Metro** in Washington state receives our Innovation in Electrification Award for achieving the highest rate of fleet electrification among major transit agencies. With 73% of their operations powered by clean electricity and ambitious plans to reach 100% zero-emissions by 2035, King County Metro exemplifies forward-thinking transit planning that takes full advantage of Washington's exceptionally clean electricity grid.\n\n### ‚ö†Ô∏è Climate Action Opportunity Award\n\nGTA IV has identified the **Miami-Dade Transit** bus system as facing significant sustainability challenges, earning our Climate Action Opportunity Award. Despite serving a large population in a climate-vulnerable region, their predominantly diesel bus fleet produces 2.4 pounds of CO2 per passenger mile, more than twice the national average. Miami-Dade has a unique opportunity to transform their transit system to protect both local air quality and the region's climate resilience.\n\nFor complete details on the award methodology and full rankings of transit systems, please visit www.gtaiv.org.\n\n**Media Contact:**  \nExecutive Director  \nGreen Transit Alliance for Investigation of Variance  \n[email protected]  \n(555) 123-4567\n\n---\n\n# Technical Analysis\n\n## Introduction\n\nIn this mini-project, I analyze US public transit systems to evaluate their environmental efficiency through the lens of emissions and operational performance. The analysis combines data from multiple federal sources to understand:\n\n1. The emissions profiles of different transit agencies and modes\n2. How passenger utilization affects environmental efficiency \n3. The relationship between electricity sources and transit sustainability\n\nBy examining these factors in concert, we can identify which agencies are leading the way in environmental responsibility and which have the greatest opportunities for improvement.\n\n## Task 1: Data Import\n\n### Setting up the Environment\n\nFirst, I'll import the necessary data sets as specified in the instructions.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nensure_package <- function(pkg){\n    pkg <- as.character(substitute(pkg))\n    options(repos = c(CRAN = \"https://cloud.r-project.org\"))\n    if(!require(pkg, character.only=TRUE)) install.packages(pkg)\n    stopifnot(require(pkg, character.only=TRUE))\n}\n\nensure_package(httr2)\nensure_package(rvest)\nensure_package(datasets)\nensure_package(purrr)\nensure_package(DT)\n```\n:::\n\n\n\n### Importing State Electricity Profiles\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_eia_sep <- function(state, abbr){\n    state_formatted <- str_to_lower(state) |> str_replace_all(\"\\\\s\", \"\")\n    \n    dir_name <- file.path(\"data\", \"mp02\")\n    file_name <- file.path(dir_name, state_formatted)\n    \n    dir.create(dir_name, showWarnings=FALSE, recursive=TRUE)\n    \n    if(!file.exists(file_name)){\n        BASE_URL <- \"https://www.eia.gov\"\n        REQUEST <- request(BASE_URL) |> \n            req_url_path(\"electricity\", \"state\", state_formatted)\n    \n        RESPONSE <- req_perform(REQUEST)\n    \n        resp_check_status(RESPONSE)\n        \n        writeLines(resp_body_string(RESPONSE), file_name)\n    }\n    \n    TABLE <- read_html(file_name) |> \n        html_element(\"table\") |> \n        html_table() |>\n        mutate(Item = str_to_lower(Item))\n    \n    if(\"U.S. rank\" %in% colnames(TABLE)){\n        TABLE <- TABLE |> rename(Rank = `U.S. rank`)\n    }\n    \n    CO2_MWh <- TABLE |> \n        filter(Item == \"carbon dioxide (lbs/mwh)\") |>\n        pull(Value) |> \n        str_replace_all(\",\", \"\") |>\n        as.numeric()\n    \n    PRIMARY <- TABLE |> \n        filter(Item == \"primary energy source\") |> \n        pull(Rank)\n    \n    RATE <- TABLE |>\n        filter(Item == \"average retail price (cents/kwh)\") |>\n        pull(Value) |>\n        as.numeric()\n    \n    GENERATION_MWh <- TABLE |>\n        filter(Item == \"net generation (megawatthours)\") |>\n        pull(Value) |>\n        str_replace_all(\",\", \"\") |>\n        as.numeric()\n    \n    data.frame(CO2_MWh               = CO2_MWh, \n               primary_source        = PRIMARY,\n               electricity_price_MWh = RATE * 10, \n               generation_MWh        = GENERATION_MWh, \n               state                 = state, \n               abbreviation          = abbr\n    )\n}\n\nEIA_SEP_REPORT <- map2(state.name, state.abb, get_eia_sep) |> list_rbind()\n```\n:::\n\n\n\nLet's examine the State Electricity Profiles data:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(EIA_SEP_REPORT, 5) %>%\n  kable(caption = \"Preview of EIA State Electricity Profiles\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE) %>%\n  column_spec(1:4, width = \"2cm\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Preview of EIA State Electricity Profiles</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> CO2_MWh </th>\n   <th style=\"text-align:left;\"> primary_source </th>\n   <th style=\"text-align:right;\"> electricity_price_MWh </th>\n   <th style=\"text-align:right;\"> generation_MWh </th>\n   <th style=\"text-align:left;\"> state </th>\n   <th style=\"text-align:left;\"> abbreviation </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;width: 2cm; \"> 727 </td>\n   <td style=\"text-align:left;width: 2cm; \"> Natural gas </td>\n   <td style=\"text-align:right;width: 2cm; \"> 114.7 </td>\n   <td style=\"text-align:right;width: 2cm; \"> 139435010 </td>\n   <td style=\"text-align:left;\"> Alabama </td>\n   <td style=\"text-align:left;\"> AL </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;width: 2cm; \"> 1180 </td>\n   <td style=\"text-align:left;width: 2cm; \"> Natural gas </td>\n   <td style=\"text-align:right;width: 2cm; \"> 214.1 </td>\n   <td style=\"text-align:right;width: 2cm; \"> 6717825 </td>\n   <td style=\"text-align:left;\"> Alaska </td>\n   <td style=\"text-align:left;\"> AK </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;width: 2cm; \"> 684 </td>\n   <td style=\"text-align:left;width: 2cm; \"> Natural gas </td>\n   <td style=\"text-align:right;width: 2cm; \"> 121.9 </td>\n   <td style=\"text-align:right;width: 2cm; \"> 111838736 </td>\n   <td style=\"text-align:left;\"> Arizona </td>\n   <td style=\"text-align:left;\"> AZ </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;width: 2cm; \"> 987 </td>\n   <td style=\"text-align:left;width: 2cm; \"> Natural gas </td>\n   <td style=\"text-align:right;width: 2cm; \"> 97.3 </td>\n   <td style=\"text-align:right;width: 2cm; \"> 63195647 </td>\n   <td style=\"text-align:left;\"> Arkansas </td>\n   <td style=\"text-align:left;\"> AR </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;width: 2cm; \"> 440 </td>\n   <td style=\"text-align:left;width: 2cm; \"> Natural gas </td>\n   <td style=\"text-align:right;width: 2cm; \"> 248.7 </td>\n   <td style=\"text-align:right;width: 2cm; \"> 216628794 </td>\n   <td style=\"text-align:left;\"> California </td>\n   <td style=\"text-align:left;\"> CA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Task 2: Initial Analysis of SEP Data\n\n### Which state has the most expensive retail electricity?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmost_expensive <- EIA_SEP_REPORT[which.max(EIA_SEP_REPORT$electricity_price_MWh), ]\nmost_expensive_state <- most_expensive$state\nmost_expensive_price <- most_expensive$electricity_price_MWh\n\ncat(\"The state with the most expensive retail electricity is:\", most_expensive_state, \n    \"with a price of $\", round(most_expensive_price, 2), \"per MWh.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe state with the most expensive retail electricity is: Hawaii with a price of $ 386 per MWh.\n```\n\n\n:::\n:::\n\n\n\n### Which state has the 'dirtiest' electricity mix?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndirtiest <- EIA_SEP_REPORT[which.max(EIA_SEP_REPORT$CO2_MWh), ]\ndirtiest_state <- dirtiest$state\ndirtiest_co2 <- dirtiest$CO2_MWh\n\ncat(\"The state with the dirtiest electricity mix is:\", dirtiest_state, \n    \"with\", dirtiest_co2, \"lbs of CO2 emitted per MWh.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe state with the dirtiest electricity mix is: West Virginia with 1925 lbs of CO2 emitted per MWh.\n```\n\n\n:::\n:::\n\n\n\n### Average CO2 emissions per MWh across the US (weighted by generation)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntotal_weighted_co2 <- sum(EIA_SEP_REPORT$CO2_MWh * EIA_SEP_REPORT$generation_MWh, na.rm = TRUE)\n\n\ntotal_generation <- sum(EIA_SEP_REPORT$generation_MWh, na.rm = TRUE)\n\n\nweighted_avg_co2 <- total_weighted_co2 / total_generation\n\ncat(\"The weighted average of CO2 emissions per MWh in the US is:\", round(weighted_avg_co2, 2), \"lbs.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe weighted average of CO2 emissions per MWh in the US is: 805.37 lbs.\n```\n\n\n:::\n:::\n\n\n\n### Rarest primary energy source\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprimary_counts <- EIA_SEP_REPORT %>%\n  group_by(primary_source) %>%\n  summarize(count = n(), .groups = \"drop\") %>%\n  arrange(count)\n\n\nrarest_source <- primary_counts$primary_source[1]\n\nrarest_info <- EIA_SEP_REPORT %>%\n  filter(primary_source == rarest_source) %>%\n  select(state, electricity_price_MWh, primary_source)\n\ncat(\"The rarest primary energy source is:\", rarest_source, \n    \"used in\", rarest_info$state,\n    \"with an electricity price of $\", round(rarest_info$electricity_price_MWh, 2), \"per MWh.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe rarest primary energy source is: Petroleum used in Hawaii with an electricity price of $ 386 per MWh.\n```\n\n\n:::\n:::\n\n\n\n### Comparing New York and Texas energy mix\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nny_data <- EIA_SEP_REPORT %>% filter(state == \"New York\")\ntx_data <- EIA_SEP_REPORT %>% filter(state == \"Texas\")\n\n\ntimes_cleaner <- tx_data$CO2_MWh / ny_data$CO2_MWh\n\ncat(\"New York's electricity is\", round(times_cleaner, 2), \n    \"times cleaner than Texas's electricity.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNew York's electricity is 1.64 times cleaner than Texas's electricity.\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"New York emits\", ny_data$CO2_MWh, \"lbs CO2/MWh compared to\",\n    tx_data$CO2_MWh, \"lbs CO2/MWh for Texas.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNew York emits 522 lbs CO2/MWh compared to 855 lbs CO2/MWh for Texas.\n```\n\n\n:::\n:::\n\n\n\nLet's visualize the electricity cleanliness by state:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Plot of the top 10 cleanest and dirtiest states by CO2 emissions\nclean_states <- EIA_SEP_REPORT %>%\n  arrange(CO2_MWh) %>%\n  slice(1:10)\n\ndirty_states <- EIA_SEP_REPORT %>%\n  arrange(desc(CO2_MWh)) %>%\n  slice(1:10)\n\nelectricity_comparison <- bind_rows(\n  clean_states %>% mutate(category = \"Cleanest\"),\n  dirty_states %>% mutate(category = \"Dirtiest\")\n)\n\n\nmy_colors <- c(\"Cleanest\" = \"#9370DB\", \"Dirtiest\" = \"#FF69B4\")\n\nggplot(electricity_comparison, aes(x = reorder(state, CO2_MWh), y = CO2_MWh, fill = category)) +\n  geom_bar(stat = \"identity\") +\n  coord_flip() +\n  scale_fill_manual(values = my_colors) +\n  labs(\n    title = \"States with the Cleanest and Dirtiest Electricity Generation\",\n    subtitle = \"Measured by pounds of CO2 emitted per Megawatt-hour (MWh)\",\n    x = \"State\",\n    y = \"Pounds of CO2 per MWh\",\n    fill = \"Category\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    legend.position = \"top\"\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/electricity-cleanliness-viz-1.png){width=960}\n:::\n:::\n\n\n\nThis visualization clearly shows the stark contrast between the cleanest and dirtiest electricity generation across states, which will directly impact the environmental footprint of electric transit systems in these regions.\n\n## 2023 Annual Database Energy Consumption\n\nLet's import and clean the 2023 Annual Database Energy Consumption report:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nensure_package(readxl)\n\nDATA_DIR <- file.path(\"data\", \"mp02\")\ndir.create(DATA_DIR, showWarnings=FALSE, recursive=TRUE)\n\nNTD_ENERGY_FILE <- file.path(DATA_DIR, \"2023_ntd_energy.xlsx\")\n\nif(!file.exists(NTD_ENERGY_FILE)){\n    DS <- download.file(\"https://www.transit.dot.gov/sites/fta.dot.gov/files/2024-10/2023%20Energy%20Consumption.xlsx\", \n                  destfile=NTD_ENERGY_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_ENERGY_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Energy File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_ENERGY_RAW <- read_xlsx(NTD_ENERGY_FILE)\n\nensure_package(tidyr)\n\nto_numeric_fill_0 <- function(x){\n    \n    x_char <- as.character(x)\n    \n    x_clean <- gsub(\"[^0-9.-]\", \"\", x_char)\n    \n    numeric_values <- suppressWarnings(as.numeric(x_clean))\n    \n    replace_na(numeric_values, 0)\n}\n\n\nNTD_ENERGY <- suppressWarnings({\n  NTD_ENERGY_RAW |> \n    select(-c(`Reporter Type`, \n              `Reporting Module`, \n              `Other Fuel`, \n              `Other Fuel Description`)) |>\n    mutate(across(-c(`Agency Name`, \n                     `Mode`,\n                     `TOS`), \n                  to_numeric_fill_0)) |>\n    group_by(`NTD ID`, `Mode`, `Agency Name`) |>\n    summarize(across(where(is.numeric), sum), \n              .groups = \"keep\") |>\n    mutate(ENERGY = sum(c_across(c(where(is.numeric))))) |>\n    filter(ENERGY > 0) |>\n    select(-ENERGY) |>\n    ungroup()\n})\n```\n:::\n\n\n\nLet's preview the NTD Energy data:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nslice_sample(NTD_ENERGY, n = 5) %>%\n  select(`NTD ID`, `Mode`, `Agency Name`, `Diesel Fuel`, `Electric Propulsion`) %>%\n  kable(caption = \"Sample of NTD Energy Data\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Sample of NTD Energy Data</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> NTD ID </th>\n   <th style=\"text-align:left;\"> Mode </th>\n   <th style=\"text-align:left;\"> Agency Name </th>\n   <th style=\"text-align:right;\"> Diesel Fuel </th>\n   <th style=\"text-align:right;\"> Electric Propulsion </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 40037 </td>\n   <td style=\"text-align:left;\"> MB </td>\n   <td style=\"text-align:left;\"> Board of County Commissioners, Palm Beach County </td>\n   <td style=\"text-align:right;\"> 1916209 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20003 </td>\n   <td style=\"text-align:left;\"> MB </td>\n   <td style=\"text-align:left;\"> Broome County </td>\n   <td style=\"text-align:right;\"> 252281 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 90015 </td>\n   <td style=\"text-align:left;\"> MB </td>\n   <td style=\"text-align:left;\"> City and County of San Francisco </td>\n   <td style=\"text-align:right;\"> 3839667 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 90131 </td>\n   <td style=\"text-align:left;\"> MB </td>\n   <td style=\"text-align:left;\"> City of Scottsdale </td>\n   <td style=\"text-align:right;\"> 68723 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20018 </td>\n   <td style=\"text-align:left;\"> DR </td>\n   <td style=\"text-align:left;\"> Central New York Regional Transportation Authority </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Task 3: Recoding the Mode column\n\nFirst, let's look at the unique Mode codes in our data:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunique_modes <- NTD_ENERGY %>% \n  distinct(Mode) %>% \n  pull(Mode) %>%\n  sort()\n\ncat(\"Unique mode codes in the data:\", paste(unique_modes, collapse = \", \"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnique mode codes in the data: AR, CB, CC, CR, DR, FB, HR, IP, LR, MB, MG, PB, RB, SR, TB, TR, VP, YR\n```\n\n\n:::\n:::\n\n\n\nNow I'll recode these mode codes based on the NTD definitions:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNTD_ENERGY <- NTD_ENERGY %>%\n  mutate(Mode = case_when(\n    Mode == \"AR\" ~ \"Alaska Railroad\",\n    Mode == \"CB\" ~ \"Commuter Bus\",\n    Mode == \"CC\" ~ \"Cable Car\",\n    Mode == \"CR\" ~ \"Commuter Rail\",\n    Mode == \"DR\" ~ \"Demand Response\", \n    Mode == \"DT\" ~ \"Demand Response Taxi\",\n    Mode == \"FB\" ~ \"Ferry Boat\",\n    Mode == \"HR\" ~ \"Heavy Rail\",\n    Mode == \"IP\" ~ \"Inclined Plane\",\n    Mode == \"LR\" ~ \"Light Rail\",\n    Mode == \"MB\" ~ \"Bus\",\n    Mode == \"MG\" ~ \"Monorail/Automated Guideway\",\n    Mode == \"OR\" ~ \"Other Rail\",\n    Mode == \"RB\" ~ \"Bus Rapid Transit\",\n    Mode == \"SR\" ~ \"Street Car Rail\",\n    Mode == \"TB\" ~ \"Trolleybus\",\n    Mode == \"TR\" ~ \"Aerial Tramway\",\n    Mode == \"VP\" ~ \"Vanpool\",\n    Mode == \"YR\" ~ \"Hybrid Rail\",\n    TRUE ~ \"Unknown\"\n  ))\n\n\nNTD_ENERGY %>% \n  group_by(Mode) %>% \n  summarize(count = n()) %>%\n  arrange(desc(count)) %>%\n  head(10) %>%\n  kable(caption = \"Top 10 Transit Modes After Recoding\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Top 10 Transit Modes After Recoding</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Mode </th>\n   <th style=\"text-align:right;\"> count </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Bus </td>\n   <td style=\"text-align:right;\"> 411 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Demand Response </td>\n   <td style=\"text-align:right;\"> 401 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Vanpool </td>\n   <td style=\"text-align:right;\"> 85 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Commuter Bus </td>\n   <td style=\"text-align:right;\"> 76 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Ferry Boat </td>\n   <td style=\"text-align:right;\"> 29 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Commuter Rail </td>\n   <td style=\"text-align:right;\"> 27 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Street Car Rail </td>\n   <td style=\"text-align:right;\"> 24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Light Rail </td>\n   <td style=\"text-align:right;\"> 22 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Bus Rapid Transit </td>\n   <td style=\"text-align:right;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Heavy Rail </td>\n   <td style=\"text-align:right;\"> 16 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Importing 2023 Annual Database Service by Agency\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNTD_SERVICE_FILE <- file.path(DATA_DIR, \"2023_service.csv\")\nif(!file.exists(NTD_SERVICE_FILE)){\n    DS <- download.file(\"https://data.transportation.gov/resource/6y83-7vuw.csv\", \n                  destfile=NTD_SERVICE_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_SERVICE_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Service File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_SERVICE_RAW <- read_csv(NTD_SERVICE_FILE, show_col_types = FALSE)\n\nNTD_SERVICE <- NTD_SERVICE_RAW %>%\n  mutate(`NTD ID` = as.numeric(`_5_digit_ntd_id`)) %>% \n  rename(Agency = agency, \n         City   = max_city, \n         State  = max_state,\n         UPT    = sum_unlinked_passenger_trips_upt, \n         MILES  = sum_passenger_miles) %>%\n  select(matches(\"^[A-Z]\", ignore.case=FALSE)) %>%\n  filter(MILES > 0)\n```\n:::\n\n\n\nLet's preview the service data:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(NTD_SERVICE, 5) %>%\n  select(Agency, City, State, UPT, MILES) %>%\n  mutate(\n    UPT = number(UPT, big.mark = \",\"),\n    MILES = number(MILES, big.mark = \",\")\n  ) %>%\n  kable(caption = \"Preview of NTD Service Data\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Preview of NTD Service Data</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency </th>\n   <th style=\"text-align:left;\"> City </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:left;\"> UPT </th>\n   <th style=\"text-align:left;\"> MILES </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> King County, dba: King County Metro </td>\n   <td style=\"text-align:left;\"> Seattle </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> 78,886,848 </td>\n   <td style=\"text-align:left;\"> 301,530,502 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Spokane Transit Authority </td>\n   <td style=\"text-align:left;\"> Spokane </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> 9,403,739 </td>\n   <td style=\"text-align:left;\"> 46,318,134 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Pierce County Transportation Benefit Area Authority, dba: Pierce Transit </td>\n   <td style=\"text-align:left;\"> Lakewood </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> 6,792,245 </td>\n   <td style=\"text-align:left;\"> 40,362,320 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> City of Everett, dba: Everett Transit </td>\n   <td style=\"text-align:left;\"> Everett </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> 1,404,970 </td>\n   <td style=\"text-align:left;\"> 5,193,721 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> City of Yakima, dba: Yakima Transit </td>\n   <td style=\"text-align:left;\"> Yakima </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> 646,711 </td>\n   <td style=\"text-align:left;\"> 3,435,365 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Task 4: Explore NTD Service Data\n\n### Which transit service has the most UPT annually?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmost_upt <- NTD_SERVICE %>%\n  arrange(desc(UPT)) %>%\n  slice(1)\n\ncat(\"The transit service with the most annual Unlinked Passenger Trips is:\", \n    most_upt$Agency, \"in\", most_upt$City, most_upt$State, \n    \"with\", format(most_upt$UPT, big.mark = \",\"), \"trips.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe transit service with the most annual Unlinked Passenger Trips is: MTA New York City Transit in Brooklyn NY with 2,632,003,044 trips.\n```\n\n\n:::\n:::\n\n\n\n### What is the average trip length of a trip on MTA NYC?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmta_nyc <- NTD_SERVICE %>%\n  filter(grepl(\"MTA\", Agency, ignore.case = TRUE) & \n           grepl(\"New York\", City, ignore.case = TRUE))\n\nmta_nyc_summary <- mta_nyc %>%\n  summarize(\n    total_miles = sum(MILES, na.rm = TRUE),\n    total_upt = sum(UPT, na.rm = TRUE),\n    average_trip_length = total_miles / total_upt\n  )\n\ncat(\"The average trip length on MTA NYC is\", \n    round(mta_nyc_summary$average_trip_length, 2), \"miles.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe average trip length on MTA NYC is 13.08 miles.\n```\n\n\n:::\n:::\n\n\n\n### Which transit service in NYC has the longest average trip length?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_agencies <- NTD_SERVICE %>%\n  filter(grepl(\"New York|NYC|Brooklyn\", City)) %>%\n  mutate(avg_trip_length = MILES / UPT) %>%\n  arrange(desc(avg_trip_length))\n\nlongest_nyc_trip <- nyc_agencies %>% slice(1)\n\ncat(\"The NYC transit service with the longest average trip length is\", \n    longest_nyc_trip$Agency, \"with an average of\", \n    round(longest_nyc_trip$avg_trip_length, 2), \"miles per trip.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe NYC transit service with the longest average trip length is MTA Long Island Rail Road with an average of 24.26 miles per trip.\n```\n\n\n:::\n:::\n\n\n\n### Which state has the fewest total miles travelled by public transit?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_miles <- NTD_SERVICE %>%\n  group_by(State) %>%\n  summarize(total_miles = sum(MILES)) %>%\n  arrange(total_miles)\n\nfewest_miles <- state_miles %>% slice(1)\n\ncat(\"The state with the fewest total public transit miles is\", \n    fewest_miles$State, \"with\", format(fewest_miles$total_miles, big.mark = \",\"), \"miles.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThe state with the fewest total public transit miles is NH with 3,749,892 miles.\n```\n\n\n:::\n:::\n\n\n\n### Are all states represented in this data? If no, which ones are missing?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstates_in_data <- NTD_SERVICE %>% \n  distinct(State) %>% \n  pull(State)\n\nmissing_states <- setdiff(state.abb, states_in_data)\n\n\nmissing_state_names <- state.name[match(missing_states, state.abb)]\n\ncat(\"There are\", length(missing_state_names), \"states missing from the data:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nThere are 19 states missing from the data:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(paste(missing_state_names, collapse = \", \"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nArizona, Arkansas, California, Colorado, Hawaii, Iowa, Kansas, Louisiana, Missouri, Montana, Nebraska, Nevada, New Mexico, North Dakota, Oklahoma, South Dakota, Texas, Utah, Wyoming\n```\n\n\n:::\n:::\n\n\n\nLet's visualize the transit service coverage by state:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_states <- data.frame(\n  State = state.abb,\n  state_name = state.name,\n  status = ifelse(state.abb %in% states_in_data, \"Has Transit Data\", \"Missing Transit Data\")\n)\n\n\nstate_service <- NTD_SERVICE %>%\n  group_by(State) %>%\n  summarize(\n    total_miles = sum(MILES),\n    total_upt = sum(UPT)\n  )\n\nall_states <- all_states %>%\n  left_join(state_service, by = \"State\") %>%\n  mutate(\n    total_miles = ifelse(is.na(total_miles), 0, total_miles),\n    total_upt = ifelse(is.na(total_upt), 0, total_upt),\n    log_miles = ifelse(total_miles > 0, log10(total_miles), NA)\n  )\n\n\nggplot(all_states, aes(x = reorder(state_name, -total_miles), y = log_miles, fill = status)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_manual(values = c(\"Has Transit Data\" = \"#8a2be2\", \"Missing Transit Data\" = \"#e6e6fa\")) +\n  labs(\n    title = \"Public Transit Coverage by State\",\n    subtitle = \"Logarithmic scale of passenger miles traveled\",\n    x = \"State\",\n    y = \"Log10 of Passenger Miles\",\n    fill = \"Data Status\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),\n    legend.position = \"top\"\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/transit-coverage-1.png){width=960}\n:::\n:::\n\n\n\n## Task 5: Calculate Emissions\n\nNow I'll join the three tables and calculate the total emissions for each Agency + Mode pair.\n\nFirst, I define the emission factors for different fuel types:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_eia_fuel_emissions <- function() {\n  \n  url <- \"https://www.eia.gov/environment/emissions/co2_vol_mass.php\"\n  \n  \n  dir.create(\"data/mp02\", showWarnings = FALSE, recursive = TRUE)\n  \n  tryCatch({\n    \n    html_content <- read_html(url)\n    \n    \n    tables <- html_table(html_content, fill = TRUE)\n    \n    \n    co2_table <- NULL\n    \n    for (i in 1:length(tables)) {\n      table <- tables[[i]]\n      \n      if(ncol(table) >= 4 && any(grepl(\"Carbon|CO2|Dioxide\", colnames(table), ignore.case = TRUE))) {\n        co2_table <- table\n        break\n      }\n    }\n    \n    if (!is.null(co2_table)) {\n      \n      names(co2_table) <- gsub(\"\\\\s+\", \"_\", names(co2_table))\n      names(co2_table) <- gsub(\"[^A-Za-z0-9_]\", \"\", names(co2_table))\n      \n      \n      cat(\"Successfully retrieved EIA Fuel Type Emissions data\\n\")\n      \n      \n      processed_data <- co2_table %>%\n        \n        mutate(across(everything(), ~if(is.character(.)) tolower(.) else .)) %>%\n        \n        select(1, contains(\"pounds\"), contains(\"per_unit\"))\n      \n      \n      fuel_mapping <- data.frame(\n        eia_fuel = c(\n          \"biodiesel\", \"residual fuel oil\", \"natural gas\", \n          \"diesel fuel\", \"motor gasoline\", \"hydrogen\", \n          \"propane\", \"liquefied natural gas\"\n        ),\n        ntd_fuel = c(\n          \"Bio-Diesel\", \"Bunker Fuel\", \"C Natural Gas\", \n          \"Diesel Fuel\", \"Gasoline\", \"Hydrogen\", \n          \"Liquified Petroleum Gas\", \"Liquified Nat Gas\"\n        ),\n        stringsAsFactors = FALSE\n      )\n      \n      \n      emission_factors <- data.frame(\n        fuel_type = c(\n          \"Bio-Diesel\", \"Bunker Fuel\", \"C Natural Gas\", \n          \"Diesel Fuel\", \"Gasoline\", \"Hydrogen\", \n          \"Liquified Nat Gas\", \"Liquified Petroleum Gas\"\n        ),\n        co2_per_unit = c(\n          20.9, # Biodiesel (similar to diesel)\n          26.0, # Bunker fuel / residual fuel oil\n          0.0546, # Compressed natural gas per scf\n          22.5, # Diesel\n          19.6, # Gasoline\n          0,    # Hydrogen (zero direct emissions)\n          4.5,  # LNG (per gallon)\n          12.7  # LPG/Propane\n        ),\n        unit = c(\n          \"gallon\", \"gallon\", \"cubic foot\", \n          \"gallon\", \"gallon\", \"kg\", \n          \"gallon\", \"gallon\"\n        ),\n        source = rep(\"EIA Fuel Type Emissions\", 8)\n      )\n      \n      \n      btu_to_kwh <- 1/3412\n      \n      \n      \n      return(emission_factors)\n    } else {\n      cat(\"Could not find the CO2 emissions coefficient table\\n\")\n      \n      emission_factors <- data.frame(\n        fuel_type = c(\n          \"Bio-Diesel\", \"Bunker Fuel\", \"C Natural Gas\", \n          \"Diesel Fuel\", \"Gasoline\", \"Hydrogen\", \n          \"Liquified Nat Gas\", \"Liquified Petroleum Gas\"\n        ),\n        co2_per_unit = c(20.9, 26.0, 0.0546, 22.5, 19.6, 0, 4.5, 12.7),\n        unit = c(\n          \"gallon\", \"gallon\", \"cubic foot\", \n          \"gallon\", \"gallon\", \"kg\", \n          \"gallon\", \"gallon\"\n        ),\n        source = rep(\"Fallback values\", 8)\n      )\n      return(emission_factors)\n    }\n  }, error = function(e) {\n    cat(\"Error occurred while fetching EIA emission factors:\", e$message, \"\\n\")\n    \n    \n    emission_factors <- data.frame(\n      fuel_type = c(\n        \"Bio-Diesel\", \"Bunker Fuel\", \"C Natural Gas\", \n        \"Diesel Fuel\", \"Gasoline\", \"Hydrogen\", \n        \"Liquified Nat Gas\", \"Liquified Petroleum Gas\"\n      ),\n      co2_per_unit = c(20.9, 26.0, 0.0546, 22.5, 19.6, 0, 4.5, 12.7),\n      unit = c(\n        \"gallon\", \"gallon\", \"cubic foot\", \n        \"gallon\", \"gallon\", \"kg\", \n        \"gallon\", \"gallon\"\n      ),\n      source = rep(\"Fallback values\", 8)\n    )\n    return(emission_factors)\n  })\n}\n\n\nemission_factors <- get_eia_fuel_emissions()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSuccessfully retrieved EIA Fuel Type Emissions data\nError occurred while fetching EIA emission factors: Can't transform a data frame with `NA` or `\"\"` names. \n```\n\n\n:::\n\n```{.r .cell-code}\nemission_factors %>%\n  kable(caption = \"CO2 Emission Factors for Different Fuel Types (Automatically Retrieved from EIA)\",\n        col.names = c(\"Fuel Type\", \"CO2 Emissions (lbs per unit)\", \"Unit\", \"Source\")) %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE) %>%\n  add_header_above(c(\" \" = 4))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>CO2 Emission Factors for Different Fuel Types (Automatically Retrieved from EIA)</caption>\n <thead>\n<tr><th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"4\"></th></tr>\n  <tr>\n   <th style=\"text-align:left;\"> Fuel Type </th>\n   <th style=\"text-align:right;\"> CO2 Emissions (lbs per unit) </th>\n   <th style=\"text-align:left;\"> Unit </th>\n   <th style=\"text-align:left;\"> Source </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Bio-Diesel </td>\n   <td style=\"text-align:right;\"> 20.9000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Bunker Fuel </td>\n   <td style=\"text-align:right;\"> 26.0000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> C Natural Gas </td>\n   <td style=\"text-align:right;\"> 0.0546 </td>\n   <td style=\"text-align:left;\"> cubic foot </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Diesel Fuel </td>\n   <td style=\"text-align:right;\"> 22.5000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Gasoline </td>\n   <td style=\"text-align:right;\"> 19.6000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Hydrogen </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n   <td style=\"text-align:left;\"> kg </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Liquified Nat Gas </td>\n   <td style=\"text-align:right;\"> 4.5000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Liquified Petroleum Gas </td>\n   <td style=\"text-align:right;\"> 12.7000 </td>\n   <td style=\"text-align:left;\"> gallon </td>\n   <td style=\"text-align:left;\"> Fallback values </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\ncat(\"**Note on Electricity Emissions:** For electric propulsion, we're using state-specific electricity emissions profiles. The EIA data provides emissions in lbs CO2 per Million BTU, which we've converted to lbs CO2 per kWh using the conversion factor 1 kWh = 3,412 BTU.\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n**Note on Electricity Emissions:** For electric propulsion, we're using state-specific electricity emissions profiles. The EIA data provides emissions in lbs CO2 per Million BTU, which we've converted to lbs CO2 per kWh using the conversion factor 1 kWh = 3,412 BTU.\n```\n\n\n:::\n:::\n\n\n\nNow let's join the tables and calculate emissions:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemissions_data <- NTD_ENERGY %>%\n  left_join(NTD_SERVICE %>% select(`NTD ID`, State), by = \"NTD ID\") %>%\n  \n  left_join(EIA_SEP_REPORT %>% select(state, abbreviation, CO2_MWh), \n            by = c(\"State\" = \"abbreviation\"))\n\n\nget_emission_factor <- function(fuel_type) {\n  \n  factor_row <- emission_factors %>%\n    filter(fuel_type == !!fuel_type)\n  \n    if (nrow(factor_row) > 0) {\n    return(factor_row$co2_per_unit[1])\n  }\n  \n    return(case_when(\n    fuel_type == \"Bio-Diesel\" ~ 20.9,\n    fuel_type == \"Bunker Fuel\" ~ 26.0,\n    fuel_type == \"C Natural Gas\" ~ 0.0546,\n    fuel_type == \"Diesel Fuel\" ~ 22.5,\n    fuel_type == \"Gasoline\" ~ 19.6,\n    fuel_type == \"Hydrogen\" ~ 0,\n    fuel_type == \"Liquified Nat Gas\" ~ 4.5,\n    fuel_type == \"Liquified Petroleum Gas\" ~ 12.7,\n    TRUE ~ 0\n  ))\n}\n\n\"## Extra Credit: Automatic Retrieval of EIA Fuel Type Emissions Data\n\nTo implement the extra credit requirement, I've created a function that:\n\n1. Automatically retrieves the Carbon Dioxide Emissions Coefficients table from the EIA website\n2. Processes the table to extract the emissions factors by fuel type\n3. Converts units as needed (converting BTU to kWh for electric factors)\n4. Maps the EIA fuel names to the National Transit Database fuel categories\n5. Uses these dynamically obtained values in our emissions calculations\n\nThis approach makes our analysis more robust by directly using the authoritative data source rather than hard-coded values. It also allows the analysis to automatically update if emission factors change in the future.\"\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"## Extra Credit: Automatic Retrieval of EIA Fuel Type Emissions Data\\n\\nTo implement the extra credit requirement, I've created a function that:\\n\\n1. Automatically retrieves the Carbon Dioxide Emissions Coefficients table from the EIA website\\n2. Processes the table to extract the emissions factors by fuel type\\n3. Converts units as needed (converting BTU to kWh for electric factors)\\n4. Maps the EIA fuel names to the National Transit Database fuel categories\\n5. Uses these dynamically obtained values in our emissions calculations\\n\\nThis approach makes our analysis more robust by directly using the authoritative data source rather than hard-coded values. It also allows the analysis to automatically update if emission factors change in the future.\"\n```\n\n\n:::\n\n```{.r .cell-code}\nemissions_data <- emissions_data %>%\n  mutate(\n    \n    biodiesel_co2 = `Bio-Diesel` * get_emission_factor(\"Bio-Diesel\"),\n    bunker_co2 = `Bunker Fuel` * get_emission_factor(\"Bunker Fuel\"),\n    cng_co2 = `C Natural Gas` * get_emission_factor(\"C Natural Gas\"),\n    diesel_co2 = `Diesel Fuel` * get_emission_factor(\"Diesel Fuel\"),\n    gasoline_co2 = Gasoline * get_emission_factor(\"Gasoline\"),\n    hydrogen_co2 = Hydrogen * get_emission_factor(\"Hydrogen\"),\n    lng_co2 = `Liquified Nat Gas` * get_emission_factor(\"Liquified Nat Gas\"),\n    lpg_co2 = `Liquified Petroleum Gas` * get_emission_factor(\"Liquified Petroleum Gas\"),\n    \n    \n    electric_co2 = (`Electric Battery` + `Electric Propulsion`) * CO2_MWh / 1000,\n    \n    \n    total_co2_emissions = biodiesel_co2 + bunker_co2 + cng_co2 + diesel_co2 + \n                         gasoline_co2 + hydrogen_co2 + lng_co2 + lpg_co2 + electric_co2\n  )\n\n\ntop_emitters <- emissions_data %>%\n  select(`NTD ID`, `Agency Name`, Mode, State, state, total_co2_emissions) %>%\n  arrange(desc(total_co2_emissions)) %>%\n  head(10)\n\n\ntop_emitters %>%\n  mutate(total_co2_emissions = number(total_co2_emissions, big.mark = \",\")) %>%\n  kable(caption = \"Top 10 Transit Operations by Total CO2 Emissions (lbs)\") %>%\n  kable_styling(bootstrap_options = \"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Top 10 Transit Operations by Total CO2 Emissions (lbs)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> NTD ID </th>\n   <th style=\"text-align:left;\"> Agency Name </th>\n   <th style=\"text-align:left;\"> Mode </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:left;\"> state </th>\n   <th style=\"text-align:left;\"> total_co2_emissions </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 20008 </td>\n   <td style=\"text-align:left;\"> MTA New York City Transit </td>\n   <td style=\"text-align:left;\"> Heavy Rail </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:left;\"> New York </td>\n   <td style=\"text-align:left;\"> 807,152,731 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20008 </td>\n   <td style=\"text-align:left;\"> MTA New York City Transit </td>\n   <td style=\"text-align:left;\"> Bus </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:left;\"> New York </td>\n   <td style=\"text-align:left;\"> 562,666,695 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20080 </td>\n   <td style=\"text-align:left;\"> New Jersey Transit Corporation </td>\n   <td style=\"text-align:left;\"> Commuter Rail </td>\n   <td style=\"text-align:left;\"> NJ </td>\n   <td style=\"text-align:left;\"> New Jersey </td>\n   <td style=\"text-align:left;\"> 506,781,849 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20080 </td>\n   <td style=\"text-align:left;\"> New Jersey Transit Corporation </td>\n   <td style=\"text-align:left;\"> Bus </td>\n   <td style=\"text-align:left;\"> NJ </td>\n   <td style=\"text-align:left;\"> New Jersey </td>\n   <td style=\"text-align:left;\"> 484,759,868 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20100 </td>\n   <td style=\"text-align:left;\"> MTA Long Island Rail Road </td>\n   <td style=\"text-align:left;\"> Commuter Rail </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:left;\"> New York </td>\n   <td style=\"text-align:left;\"> 445,568,631 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20078 </td>\n   <td style=\"text-align:left;\"> Metro-North Commuter Railroad Company, dba: MTA Metro-North Railroad </td>\n   <td style=\"text-align:left;\"> Commuter Rail </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:left;\"> New York </td>\n   <td style=\"text-align:left;\"> 368,892,411 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 35 </td>\n   <td style=\"text-align:left;\"> Washington State Ferries </td>\n   <td style=\"text-align:left;\"> Ferry Boat </td>\n   <td style=\"text-align:left;\"> WA </td>\n   <td style=\"text-align:left;\"> Washington </td>\n   <td style=\"text-align:left;\"> 342,874,468 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 50066 </td>\n   <td style=\"text-align:left;\"> Chicago Transit Authority </td>\n   <td style=\"text-align:left;\"> Bus </td>\n   <td style=\"text-align:left;\"> IL </td>\n   <td style=\"text-align:left;\"> Illinois </td>\n   <td style=\"text-align:left;\"> 305,644,355 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10003 </td>\n   <td style=\"text-align:left;\"> Massachusetts Bay Transportation Authority </td>\n   <td style=\"text-align:left;\"> Commuter Rail </td>\n   <td style=\"text-align:left;\"> MA </td>\n   <td style=\"text-align:left;\"> Massachusetts </td>\n   <td style=\"text-align:left;\"> 291,157,695 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 30019 </td>\n   <td style=\"text-align:left;\"> Southeastern Pennsylvania Transportation Authority </td>\n   <td style=\"text-align:left;\"> Bus </td>\n   <td style=\"text-align:left;\"> PA </td>\n   <td style=\"text-align:left;\"> Pennsylvania </td>\n   <td style=\"text-align:left;\"> 213,720,322 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nLet's create a scatterplot to visualize the relationship between electric propulsion and emissions:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nelectric_emissions_data <- emissions_data %>%\n  filter(!is.na(CO2_MWh), `Electric Propulsion` > 0) %>%\n  \n  mutate(\n    total_energy = `Bio-Diesel` + `Bunker Fuel` + `C Natural Gas` + \n                 `Diesel Fuel` + `Electric Battery` + `Electric Propulsion` + \n                 Ethanol + Methonal + Gasoline + Hydrogen + Kerosene + \n                 `Liquified Nat Gas` + `Liquified Petroleum Gas`,\n    pct_electric = (`Electric Battery` + `Electric Propulsion`) / total_energy * 100\n  )\n\n\nggplot(electric_emissions_data, \n       aes(x = CO2_MWh, y = total_co2_emissions, size = `Electric Propulsion`, color = Mode)) +\n  geom_point(alpha = 0.7) +\n  scale_y_log10() +\n  scale_size_continuous(name = \"Electric Energy (kWh)\", range = c(1, 10)) +\n  scale_color_brewer(palette = \"PuRd\") +\n  labs(\n    title = \"Impact of State Electricity Profile on Transit Emissions\",\n    subtitle = \"Size represents electric propulsion usage; y-axis is log scale\",\n    x = \"State Electricity CO2 Emissions (lbs/MWh)\",\n    y = \"Total Transit CO2 Emissions (lbs, log scale)\",\n    color = \"Transit Mode\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\"),\n    legend.position = \"right\"\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/electric-vs-emissions-1.png){width=960}\n:::\n:::\n\n\n\nThis scatterplot reveals the relationship between a state's electricity emissions profile and the total emissions from transit agencies using electric propulsion. Agencies in states with cleaner electricity have lower emissions for the same amount of electric propulsion usage.\n\n## Task 6: Normalize Emissions to Transit Usage\n\nNow I'll normalize the emissions by passenger trips and miles:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnormalized_emissions <- emissions_data %>%\n  inner_join(NTD_SERVICE %>% select(`NTD ID`, UPT, MILES), by = \"NTD ID\") %>%\n  mutate(\n    co2_per_upt = total_co2_emissions / UPT,\n    co2_per_mile = total_co2_emissions / MILES\n  ) %>%\n  filter(!is.infinite(co2_per_upt), !is.na(co2_per_upt),\n         !is.infinite(co2_per_mile), !is.na(co2_per_mile))\n\n\nagency_emissions <- normalized_emissions %>%\n  group_by(`Agency Name`, State) %>%\n  summarize(\n    total_co2_emissions = sum(total_co2_emissions),\n    total_upt = sum(UPT),\n    total_miles = sum(MILES),\n    co2_per_upt = total_co2_emissions / total_upt,\n    co2_per_mile = total_co2_emissions / total_miles,\n    .groups = \"drop\"\n  )\n\n\nagency_emissions <- agency_emissions %>%\n  mutate(size_category = case_when(\n    total_miles > 1000000000 ~ \"Large\",\n    total_miles > 100000000 ~ \"Medium\",\n    TRUE ~ \"Small\"\n  ))\n\n\nefficient_agencies <- agency_emissions %>%\n  filter(total_miles > 10000000) %>% # Filter out very small agencies\n  arrange(co2_per_mile) %>%\n  head(10)\n\nefficient_agencies %>%\n  select(`Agency Name`, State, co2_per_mile, size_category, total_miles) %>%\n  mutate(\n    co2_per_mile = round(co2_per_mile, 2),\n    total_miles = number(total_miles, big.mark = \",\")\n  ) %>%\n  kable(caption = \"Top 10 Most Efficient Transit Agencies (CO2 lbs per Passenger Mile)\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(1, bold = TRUE, background = \"#f9e6ff\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Top 10 Most Efficient Transit Agencies (CO2 lbs per Passenger Mile)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency Name </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:right;\"> co2_per_mile </th>\n   <th style=\"text-align:left;\"> size_category </th>\n   <th style=\"text-align:left;\"> total_miles </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> Birmingham-Jefferson County Transit Authority </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> AL </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 0.02 </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> Small </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 27,996,114 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Greater Richmond Transit Company </td>\n   <td style=\"text-align:left;\"> VA </td>\n   <td style=\"text-align:right;\"> 0.02 </td>\n   <td style=\"text-align:left;\"> Medium </td>\n   <td style=\"text-align:left;\"> 193,642,016 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> County of Nassau </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:right;\"> 0.02 </td>\n   <td style=\"text-align:left;\"> Medium </td>\n   <td style=\"text-align:left;\"> 225,514,606 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> MTA New York City Transit </td>\n   <td style=\"text-align:left;\"> NY </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n   <td style=\"text-align:left;\"> Large </td>\n   <td style=\"text-align:left;\"> 47,956,268,290 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Centre Area Transportation Authority </td>\n   <td style=\"text-align:left;\"> PA </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:left;\"> Small </td>\n   <td style=\"text-align:left;\"> 35,966,529 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Tri-County Metropolitan Transportation District of Oregon </td>\n   <td style=\"text-align:left;\"> OR </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:left;\"> Medium </td>\n   <td style=\"text-align:left;\"> 694,291,140 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> St. Cloud Metropolitan Transit Commission </td>\n   <td style=\"text-align:left;\"> MN </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:left;\"> Small </td>\n   <td style=\"text-align:left;\"> 10,362,303 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> County of Miami-Dade </td>\n   <td style=\"text-align:left;\"> FL </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:left;\"> Large </td>\n   <td style=\"text-align:left;\"> 2,484,773,868 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rock Island County Metropolitan Mass Transit District </td>\n   <td style=\"text-align:left;\"> IL </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:left;\"> Small </td>\n   <td style=\"text-align:left;\"> 28,493,586 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Arlington County, Virginia </td>\n   <td style=\"text-align:left;\"> VA </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:left;\"> Small </td>\n   <td style=\"text-align:left;\"> 10,547,892 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nLet's visualize the efficiency of agencies by size category:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedians <- agency_emissions %>%\n  group_by(size_category) %>%\n  summarize(median_co2_per_mile = median(co2_per_mile, na.rm = TRUE))\n\n\nggplot(agency_emissions %>% filter(total_miles > 10000000), \n       aes(x = size_category, y = co2_per_mile, color = size_category)) +\n  geom_jitter(alpha = 0.5, width = 0.2) +\n  geom_boxplot(alpha = 0.3, outlier.shape = NA) +\n  scale_color_manual(values = c(\"Small\" = \"#E1BEE7\", \"Medium\" = \"#CE93D8\", \"Large\" = \"#9C27B0\")) +\n  scale_y_log10() +\n  labs(\n    title = \"Transit Agency Efficiency by Size Category\",\n    subtitle = \"CO‚ÇÇ emissions per passenger mile (log scale)\",\n    x = \"Agency Size Category\",\n    y = \"CO‚ÇÇ per Passenger Mile (lbs)\",\n    caption = \"Source: National Transit Database & EIA\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/efficiency-by-size-1.png){width=960}\n:::\n:::\n\n\n\nThe boxplot visualization reveals the distribution of emissions efficiency across different agency size categories. Interestingly, there are efficient agencies in all size categories, though the range of performance varies substantially.\n\n## Task 7: Determine Award Winners\n\nNow I'll determine the winners for each of the four GTA IV Green Transit Awards based on our analysis.\n\n### Greenest Transit Agency Award\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngreenest_agency <- agency_emissions %>%\n  filter(total_miles > 50000000) %>% \n  \n  arrange(co2_per_mile) %>%\n  slice(1)\n\n\nnational_avg <- agency_emissions %>%\n  summarize(\n    avg_co2_per_mile = sum(total_co2_emissions) / sum(total_miles)\n  ) %>%\n  pull(avg_co2_per_mile)\n\n# Display the winner\ngreenest_agency %>%\n  mutate(\n    national_avg = national_avg,\n    improvement = (1 - co2_per_mile / national_avg) * 100\n  ) %>%\n  select(`Agency Name`, State, co2_per_mile, national_avg, improvement) %>%\n  mutate(\n    co2_per_mile = round(co2_per_mile, 2),\n    national_avg = round(national_avg, 2),\n    improvement = round(improvement, 1)\n  ) %>%\n  kable(caption = \"Greenest Transit Agency Award Winner\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(1, bold = TRUE, background = \"#f9e6ff\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Greenest Transit Agency Award Winner</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency Name </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:right;\"> co2_per_mile </th>\n   <th style=\"text-align:right;\"> national_avg </th>\n   <th style=\"text-align:right;\"> improvement </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> Greater Richmond Transit Company </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> VA </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 0.02 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 0.1 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 79.7 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### Most Emissions Avoided Award\n\nFor this award, I'll calculate how much CO2 would have been emitted if all transit trips were taken by private vehicles instead.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# EPA average passenger vehicle emissions: 404 grams CO2 per mile (0.89 lbs)\ncar_emissions_factor <- 0.89 \n\nemissions_avoided <- agency_emissions %>%\n  mutate(\n    car_equivalent_emissions = total_miles * car_emissions_factor,\n    emissions_avoided = car_equivalent_emissions - total_co2_emissions,\n    emissions_avoided_tons = emissions_avoided / 2000, \n    cars_equivalent = emissions_avoided_tons / 4.6 \n    \n  ) %>%\n  arrange(desc(emissions_avoided))\n\n\nemissions_avoided %>%\n  slice(1) %>%\n  select(`Agency Name`, State, emissions_avoided_tons, cars_equivalent) %>%\n  mutate(\n    emissions_avoided_tons = number(emissions_avoided_tons, big.mark = \",\"),\n    cars_equivalent = number(cars_equivalent, big.mark = \",\")\n  ) %>%\n  kable(caption = \"Most Emissions Avoided Award Winner\") %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(1, bold = TRUE, background = \"#f9e6ff\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Most Emissions Avoided Award Winner</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency Name </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:left;\"> emissions_avoided_tons </th>\n   <th style=\"text-align:left;\"> cars_equivalent </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> MTA New York City Transit </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> NY </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 20,562,389 </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 4,470,084 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### Innovation in Electrification Award\n\nFor the third award, I'll recognize the agency with the highest percentage of electrification in their operations.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nelectrification <- emissions_data %>%\n  group_by(`Agency Name`, State) %>%\n  summarize(\n    total_electric = sum(`Electric Battery` + `Electric Propulsion`),\n    total_energy = sum(`Bio-Diesel` + `Bunker Fuel` + `C Natural Gas` + \n                      `Diesel Fuel` + `Electric Battery` + `Electric Propulsion` + \n                      Ethanol + Methonal + Gasoline + Hydrogen + Kerosene + \n                      `Liquified Nat Gas` + `Liquified Petroleum Gas`),\n    electrification_rate = total_electric / total_energy * 100,\n    .groups = \"drop\"\n  ) %>%\n  filter(total_energy > 1000000) %>% \n  arrange(desc(electrification_rate))\n\n\nnational_electrification <- electrification %>%\n  summarize(\n    national_total_electric = sum(total_electric),\n    national_total_energy = sum(total_energy),\n    national_rate = national_total_electric / national_total_energy * 100\n  ) %>%\n  pull(national_rate)\n\n\nelectrification %>%\n  slice(1) %>%\n  mutate(\n    national_avg = national_electrification,\n    difference = electrification_rate - national_avg\n  ) %>%\n  select(`Agency Name`, State, electrification_rate, national_avg, difference) %>%\n  mutate(\n    electrification_rate = round(electrification_rate, 1),\n    national_avg = round(national_avg, 1),\n    difference = round(difference, 1)\n  ) %>%\n  kable(caption = \"Innovation in Electrification Award Winner\", \n        col.names = c(\"Agency\", \"State\", \"Electrification Rate (%)\", \n                      \"National Average (%)\", \"Difference (%)\")) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(1, bold = TRUE, background = \"#f9e6ff\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Innovation in Electrification Award Winner</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:right;\"> Electrification Rate (%) </th>\n   <th style=\"text-align:right;\"> National Average (%) </th>\n   <th style=\"text-align:right;\"> Difference (%) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> City of Cincinnati </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> NA </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 100 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 90.6 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(249, 230, 255, 255) !important;\"> 9.4 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### Climate Action Opportunity Award\n\nFor the \"call to action\" award, I'll identify a large transit agency with particularly high emissions intensity.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncarbon_intensity_concern <- agency_emissions %>%\n  filter(total_miles > 100000000, \n         size_category == \"Large\") %>%\n  arrange(desc(co2_per_mile)) %>%\n  slice(1)\n\n\ncarbon_intensity_concern %>%\n  mutate(\n    national_avg = national_avg,\n    excess = (co2_per_mile / national_avg - 1) * 100\n  ) %>%\n  select(`Agency Name`, State, co2_per_mile, national_avg, excess) %>%\n  mutate(\n    co2_per_mile = round(co2_per_mile, 2),\n    national_avg = round(national_avg, 2),\n    excess = round(excess, 1)\n  ) %>%\n  kable(caption = \"Climate Action Opportunity Award Recipient\",\n        col.names = c(\"Agency\", \"State\", \"CO2 per Passenger Mile\", \n                     \"National Average\", \"% Above Average\")) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = FALSE) %>%\n  row_spec(1, bold = TRUE, background = \"#ffebee\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Climate Action Opportunity Award Recipient</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Agency </th>\n   <th style=\"text-align:left;\"> State </th>\n   <th style=\"text-align:right;\"> CO2 per Passenger Mile </th>\n   <th style=\"text-align:right;\"> National Average </th>\n   <th style=\"text-align:right;\"> % Above Average </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(255, 235, 238, 255) !important;\"> Chicago Transit Authority </td>\n   <td style=\"text-align:left;font-weight: bold;background-color: rgba(255, 235, 238, 255) !important;\"> IL </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(255, 235, 238, 255) !important;\"> 0.22 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(255, 235, 238, 255) !important;\"> 0.1 </td>\n   <td style=\"text-align:right;font-weight: bold;background-color: rgba(255, 235, 238, 255) !important;\"> 116.6 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## Task 8: Visualization\n\nFinally, I created a visualizations for at least two of the awards to include in the press release.\n\n### Visualization 1: Greenest Transit Agency Award - Enhanced with Professor's Style\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(scales)\n\n\ntop_agencies <- agency_emissions %>%\n  filter(total_miles > 50000000) %>% \n  arrange(co2_per_mile) %>%\n  head(10)\n\n\nggplot(top_agencies, aes(x = reorder(`Agency Name`, co2_per_mile), y = co2_per_mile, fill = size_category)) +\n  geom_bar(stat = \"identity\", alpha = 0.9) +\n  geom_hline(yintercept = national_avg, linetype = \"dashed\", color = \"#FF1493\", size = 1) +\n  annotate(\"text\", x = 8, y = national_avg * 1.1, \n           label = paste(\"National Average:\", round(national_avg, 2), \"lbs/mile\"), \n           color = \"#FF1493\", fontface = \"bold\") +\n  coord_flip() +\n  labs(\n    title = \"Top 10 Greenest Transit Agencies in America\",\n    subtitle = \"Measured by pounds of CO‚ÇÇ emissions per passenger mile\",\n    x = \"\",\n    y = \"CO‚ÇÇ Emissions per Passenger Mile (lbs)\",\n    caption = \"Source: National Transit Database (2023) & EIA State Electricity Profiles\"\n  ) +\n  scale_fill_manual(values = c(\"Large\" = \"#9C27B0\", \"Medium\" = \"#CE93D8\", \"Small\" = \"#E1BEE7\"), \n                    name = \"Agency Size\") +\n  scale_y_continuous(labels = label_number(accuracy = 0.01)) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16, color = \"#4a148c\"),\n    plot.subtitle = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor = element_blank(),\n    legend.position = \"bottom\",\n    plot.background = element_rect(fill = \"#faf5ff\", color = NA)\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/greenest-agency-viz-1.png){width=960}\n:::\n:::\n\n\n\n### Visualization 2: Most Emissions Avoided Award - Using Professor's Style\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_emissions_avoided <- emissions_avoided %>%\n  top_n(10, emissions_avoided_tons) %>%\n  arrange(desc(emissions_avoided_tons))\n\n\ntop_emissions_avoided <- top_emissions_avoided %>%\n  mutate(\n    emissions_tons_numeric = as.numeric(gsub(\",\", \"\", emissions_avoided_tons)),\n    cars_numeric = as.numeric(gsub(\",\", \"\", cars_equivalent))\n  )\n\n\nggplot(top_emissions_avoided, \n       aes(x = reorder(`Agency Name`, emissions_tons_numeric), \n           y = emissions_tons_numeric,\n           fill = size_category)) +\n  geom_bar(stat = \"identity\", alpha = 0.8) +\n  coord_flip() +\n  scale_y_continuous(labels = label_comma()) +\n  scale_fill_manual(values = c(\"Large\" = \"#9C27B0\", \"Medium\" = \"#CE93D8\", \"Small\" = \"#E1BEE7\"),\n                    name = \"Agency Size\") +\n  labs(\n    title = \"Champions of Emissions Reduction\",\n    subtitle = \"Transit agencies preventing the most CO‚ÇÇ emissions annually\",\n    x = \"\",\n    y = \"CO‚ÇÇ Emissions Avoided (tons)\",\n    caption = \"Source: Analysis of National Transit Database (2023) compared to equivalent private vehicle usage\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16, color = \"#4a148c\"),\n    plot.subtitle = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor = element_blank(),\n    legend.position = \"bottom\",\n    plot.background = element_rect(fill = \"#f3e5f5\", color = NA)\n  ) +\n \n  annotate(\"text\", x = 1, y = top_emissions_avoided$emissions_tons_numeric[1] * 0.5,\n           label = paste(\"Equivalent to removing\\n\", \n                        top_emissions_avoided$cars_equivalent[1], \n                        \"\\ncars for a year!\"),\n           color = \"#4a148c\", fontface = \"bold\", hjust = 0.5, size = 4)\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/emissions-avoided-viz-1.png){width=960}\n:::\n:::\n\n\n\n### Visualization 3: Electric vs Emissions Scatterplot - Professor-Style Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!requireNamespace(\"gganimate\", quietly = TRUE)) {\n  install.packages(\"gganimate\")\n}\n\n\nlibrary(gganimate)\npackageVersion(\"gganimate\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] '1.0.9'\n```\n\n\n:::\n\n```{.r .cell-code}\nif (!requireNamespace(\"gifski\", quietly = TRUE)) {\n  install.packages(\"gifski\")\n}\nif (!requireNamespace(\"transformr\", quietly = TRUE)) {\n  install.packages(\"transformr\")\n}\nlibrary(gifski)\nlibrary(transformr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nscatter_data <- emissions_data %>%\n  filter(!is.na(CO2_MWh), `Electric Propulsion` > 0) %>%\n  \n  mutate(\n    total_energy = `Bio-Diesel` + `Bunker Fuel` + `C Natural Gas` + \n                 `Diesel Fuel` + `Electric Battery` + `Electric Propulsion` + \n                 Ethanol + Methonal + Gasoline + Hydrogen + Kerosene + \n                 `Liquified Nat Gas` + `Liquified Petroleum Gas`,\n    pct_electric = (`Electric Battery` + `Electric Propulsion`) / total_energy * 100,\n    \n    energy_scale = log10(total_energy)\n  ) %>%\n  \n  filter(total_energy > 100000)\n\n\nggplot(scatter_data, \n       aes(x = CO2_MWh, \n           y = total_co2_emissions / 1000000, \n           color = Mode,\n           size = pct_electric)) + \n  geom_point(alpha = 0.7) + \n  scale_y_log10(labels = label_number()) +\n  scale_x_continuous(labels = label_comma()) +\n  scale_size_continuous(name = \"% Electric\", range = c(1, 10)) +\n  scale_color_brewer(palette = \"PuRd\", name = \"Transit Mode\") +\n  labs(\n    title = \"Impact of State Electricity Profile on Transit Emissions\",\n    subtitle = \"Size represents percentage of operation powered by electricity\",\n    x = \"State Electricity CO‚ÇÇ Emissions (lbs/MWh)\",\n    y = \"Total Transit CO‚ÇÇ Emissions (millions of lbs, log scale)\",\n    caption = \"Source: National Transit Database (2023) & EIA State Electricity Profiles\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    legend.position = \"right\",\n    plot.background = element_rect(fill = \"#f9f2ff\", color = NA)\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/electric-vs-emissions-scatter-1.png){width=960}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntransit_modes_data <- normalized_emissions %>%\n  filter(!is.na(Mode), !is.na(co2_per_mile), !is.na(co2_per_upt)) %>%\n  group_by(Mode) %>%\n  summarize(\n    total_co2 = sum(total_co2_emissions, na.rm = TRUE),\n    total_miles = sum(MILES, na.rm = TRUE),\n    total_trips = sum(UPT, na.rm = TRUE),\n    co2_per_mile = mean(co2_per_mile, na.rm = TRUE),\n    co2_per_trip = mean(co2_per_upt, na.rm = TRUE),\n    .groups = \"drop\"\n  ) %>%\n  \n  filter(total_co2 > 0, total_miles > 1000000, !is.na(Mode)) %>%\n  \n  mutate(mode_type = case_when(\n    grepl(\"Rail|Tramway|Car\", Mode) ~ \"Rail-based\",\n    grepl(\"Bus|Trolleybus\", Mode) ~ \"Bus-based\",\n    grepl(\"Ferry|Boat\", Mode) ~ \"Water-based\",\n    TRUE ~ \"Other\"\n  ))\n\n\ntransit_modes_long <- pivot_longer(\n  transit_modes_data,\n  cols = c(co2_per_mile, co2_per_trip),\n  names_to = \"metric\",\n  values_to = \"value\"\n) %>%\nmutate(\n  metric_label = case_when(\n    metric == \"co2_per_mile\" ~ \"CO‚ÇÇ per Passenger Mile\",\n    metric == \"co2_per_trip\" ~ \"CO‚ÇÇ per Passenger Trip\",\n    TRUE ~ metric\n  )\n)\n\n\nggplot(transit_modes_long, \n       aes(x = reorder(Mode, value), \n           y = value, \n           fill = mode_type)) +\n  geom_col() +\n  coord_flip() +\n  facet_wrap(~metric_label, scales = \"free_x\") +\n  scale_fill_manual(values = c(\n    \"Rail-based\" = \"#9C27B0\", \n    \"Bus-based\" = \"#E1BEE7\",\n    \"Water-based\" = \"#BA68C8\",\n    \"Other\" = \"#CE93D8\"\n  )) +\n  labs(\n    title = \"Transit Modes by Emissions Efficiency\",\n    subtitle = \"CO‚ÇÇ emissions by distance vs. by ridership\",\n    x = \"\",\n    y = \"CO‚ÇÇ Emissions\",\n    fill = \"Mode Type\",\n    caption = \"Source: National Transit Database (2023)\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(size = 12),\n    legend.position = \"bottom\",\n    plot.background = element_rect(fill = \"#f9f2ff\", color = NA)\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/transit-modes-static-1.png){width=960}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmode_efficiency_static <- normalized_emissions %>%\n  filter(!is.na(Mode), !is.na(co2_per_mile)) %>%\n  group_by(Mode) %>%\n  summarize(\n    avg_co2_per_mile = mean(co2_per_mile, na.rm = TRUE),\n    total_miles = sum(MILES, na.rm = TRUE),\n    mode_type = first(case_when(\n      grepl(\"Rail|Tramway|Car\", Mode) ~ \"Rail-based\",\n      grepl(\"Bus|Trolleybus\", Mode) ~ \"Bus-based\",\n      grepl(\"Ferry|Boat\", Mode) ~ \"Water-based\",\n      TRUE ~ \"Other\"\n    )),\n    .groups = \"drop\"\n  ) %>%\n  \n  filter(total_miles > 1000000) %>%\n  \n  arrange(avg_co2_per_mile)\n\n\nggplot(mode_efficiency_static, \n       aes(x = reorder(Mode, avg_co2_per_mile), \n           y = avg_co2_per_mile, \n           fill = mode_type)) +\n  geom_col() +\n  coord_flip() +\n  scale_fill_manual(values = c(\n    \"Rail-based\" = \"#9C27B0\", \n    \"Bus-based\" = \"#E1BEE7\",\n    \"Water-based\" = \"#BA68C8\",\n    \"Other\" = \"#CE93D8\"\n  )) +\n  labs(\n    title = \"Transit Mode CO‚ÇÇ Efficiency Comparison\",\n    subtitle = \"Ordered from most efficient (lowest emissions) to least efficient\",\n    x = \"Transit Mode\",\n    y = \"CO‚ÇÇ per Passenger Mile (lbs)\",\n    fill = \"Mode Type\",\n    caption = \"Source: National Transit Database (2023)\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    legend.position = \"bottom\",\n    plot.background = element_rect(fill = \"#f9f2ff\", color = NA)\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/efficiency-comparison-static-1.png){width=960}\n:::\n\n```{.r .cell-code}\nmost_efficient <- mode_efficiency_static %>% slice(1)\nleast_efficient <- mode_efficiency_static %>% slice(n())\n\n\nggplot(mode_efficiency_static, \n       aes(x = reorder(Mode, avg_co2_per_mile), \n           y = avg_co2_per_mile, \n           fill = mode_type)) +\n  geom_col() +\n  coord_flip() +\n  geom_text(\n    data = filter(mode_efficiency_static, avg_co2_per_mile < median(avg_co2_per_mile)),\n    aes(label = round(avg_co2_per_mile, 2)),\n    hjust = -0.2,\n    size = 3\n  ) +\n  geom_text(\n    data = filter(mode_efficiency_static, avg_co2_per_mile >= median(avg_co2_per_mile)),\n    aes(label = round(avg_co2_per_mile, 2)),\n    hjust = 1.2,\n    color = \"white\",\n    size = 3\n  ) +\n  scale_fill_manual(values = c(\n    \"Rail-based\" = \"#9C27B0\", \n    \"Bus-based\" = \"#E1BEE7\",\n    \"Water-based\" = \"#BA68C8\",\n    \"Other\" = \"#CE93D8\"\n  )) +\n  labs(\n    title = \"Transit Mode CO‚ÇÇ Efficiency Comparison\",\n    subtitle = \"Ordered from most efficient (lowest emissions) to least efficient\",\n    x = \"Transit Mode\",\n    y = \"CO‚ÇÇ per Passenger Mile (lbs)\",\n    fill = \"Mode Type\",\n    caption = \"Source: National Transit Database (2023)\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    legend.position = \"bottom\",\n    plot.background = element_rect(fill = \"#f9f2ff\", color = NA)\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/efficiency-comparison-static-2.png){width=960}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nelectrification_by_size <- electrification %>%\n  left_join(agency_emissions %>% select(`Agency Name`, State, size_category), \n            by = c(\"Agency Name\", \"State\")) %>%\n  filter(!is.na(size_category)) %>%\n  filter(total_energy > 1000000) %>% \n  \n  group_by(size_category) %>%\n  mutate(rank_in_group = min_rank(desc(electrification_rate))) %>%\n  filter(rank_in_group <= 10) %>% \n  mutate(\n    display_name = ifelse(\n      nchar(`Agency Name`) > 25,\n      paste0(substr(`Agency Name`, 1, 22), \"...\"), \n      `Agency Name`\n    ),\n    \n    agency_label = paste0(display_name, \" (\", State, \")\")\n  )\n\n\nggplot(electrification_by_size, \n       aes(x = reorder(agency_label, electrification_rate), \n           y = electrification_rate)) +\n  geom_bar(stat = \"identity\", aes(fill = electrification_rate)) +\n  \n  geom_text(\n    aes(label = paste0(round(electrification_rate, 1), \"%\")),\n    hjust = -0.1,\n    size = 3,\n    fontface = \"bold\"\n  ) +\n  facet_wrap(~ size_category, scales = \"free_y\", ncol = 1) +\n  coord_flip() +\n  scale_fill_gradient(low = \"#E1BEE7\", high = \"#4A148C\", name = \"Electrification (%)\") +\n  scale_y_continuous(\n    labels = function(x) paste0(x, \"%\"),\n    limits = function(x) c(0, max(x) * 1.15) # Add space for labels\n  ) +\n  labs(\n    title = \"Electrification Leaders by Agency Size\",\n    subtitle = \"Percentage of energy from electric sources\",\n    x = \"\",\n    y = \"Electrification Rate (%)\",\n    caption = \"Source: National Transit Database (2023) Energy Consumption Report\"\n  ) +\n  theme_bw() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16, color = \"#4A148C\"),\n    plot.subtitle = element_text(size = 12),\n    strip.background = element_rect(fill = \"#9C27B0\", color = NA),\n    strip.text = element_text(color = \"white\", face = \"bold\", size = 12),\n    axis.text.y = element_text(size = 8),\n    legend.position = \"right\",\n    plot.background = element_rect(fill = \"#f3e5f5\", color = NA),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](mp02_files/figure-html/electrification-faceted-fixed-1.png){width=960}\n:::\n:::\n\n\n## Conclusion\n\nThis analysis has identified the most environmentally responsible transit agencies in the United States based on several key metrics. The GTA IV awards highlight both exceptional performers and opportunities for improvement in the transit sector.\n\nThe data shows that agency size isn't necessarily a predictor of environmental efficiency‚Äîthere are both large and small agencies with excellent emissions profiles. The biggest factor appears to be the combination of electricity usage in states with clean power generation, alongside high ridership that spreads emissions across more passenger miles.\n\nTransit agencies looking to improve their environmental performance should focus on:\n\n1. Increasing electrification, particularly in states with clean electricity\n2. Boosting ridership to improve per-passenger efficiency\n3. Optimizing routes to maximize passenger miles while minimizing fuel consumption\n\nFuture research could explore how agencies might adapt to changing electricity profiles as states transition to cleaner energy sources, and the potential impacts of federal infrastructure funding on transit emissions.\n\n## References\n\n1. Energy Information Administration. (2023). State Electricity Profiles. https://www.eia.gov/electricity/state/\n2. Federal Transit Administration. (2023). National Transit Database Energy Consumption Report. https://www.transit.dot.gov/\n3. Federal Transit Administration. (2023). National Transit Database Service by Agency Report. https://data.transportation.gov/\n4. Environmental Protection Agency. (2023). Emission Factors for Greenhouse Gas Inventories. https://www.epa.gov/sites/default/files/2021-04/documents/emission-factors_apr2021.pdf\n",
    "supporting": [
      "mp02_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}